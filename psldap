# Import the ActiveDirectory module
Import-Module ActiveDirectory

# Check for the -h or -help switch
if ($args -contains "-h" -or $args -contains "-help") {
    Write-Output "Usage: .\script.ps1 [-Filter <filter>] [-Attributes <attributes>] [-Server <server>] [-h]"
    Write-Output ""
    Write-Output "Options:"
    Write-Output "  -Filter <filter>          Set the LDAP filter to use (default: (sAMAccountName=$env:USERNAME))"
    Write-Output "  -Attributes <attributes>  Set the comma-separated list of attributes to return (default: mail,telephonenumber)"
    Write-Output "  -Server <server>          Set the Active Directory server to query (default: $env:USERDNSDOMAIN)"
    Write-Output "  -Verbose                  Enable verbose output for debugging purposes"
    Write-Output "  -h, -help                 Show this help message"
    Write-Output ""
    Write-Output "Examples:"
    Write-Output "  .\script.ps1"
    Write-Output "  .\script.ps1 -Filter '(givenName=John)' -Attributes 'mail,telephoneNumber,title' -Server 'mydomain.com'"
    return
}

# Set default values for filter, attributes, and server
$Filter = "(sAMAccountName=$env:USERNAME)"
$Attributes = "mail,telephonenumber"
$Server = $env:USERDNSDOMAIN
$VerboseOutput = $false

# Parse command line arguments
for ($i=0; $i -lt $args.Length; $i++) {
    switch ($args[$i]) {
        "-Filter" {
            $Filter = $args[++$i]
        }
        "-Attributes" {
            $Attributes = $args[++$i]
        }
        "-Server" {
            $Server = $args[++$i]
        }
        "-Verbose" {
            $VerboseOutput = $true
        }
    }
}

# Build the LDAP query using the filter and attributes
$query = New-Object System.DirectoryServices.DirectorySearcher
$query.SearchRoot = "LDAP://$Server"
$query.Filter = $Filter
$query.PropertiesToLoad.AddRange($Attributes.Split(','))

# Perform the LDAP query and output the results
$result = $query.FindAll()
foreach ($entry in $result) {
    foreach ($property in $entry.Properties) {
        if ($property.Value.Count -gt 0) {
            Write-Output "$($property.Name): $($property.Value[0])"
        } else {
            Write-Output "$($property.Name):"
        }
    }
    Write-Output ""
}

if ($VerboseOutput) {
    Write-Output "LDAP query filter: $Filter"
    Write-Output "LDAP query attributes: $Attributes"
    Write-Output "LDAP server: $Server"
}
